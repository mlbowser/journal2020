
## Monday, April 27

```shell
## Trying to figure out why denoising didn't work.
## The denoise command I issued the other day yielded an output file with 0 lines.
## Command: vsearch --cluster_unoise out_funits/intermediate/derep.ITS2.sizefiltered.fasta --sizein --sizeout --minsize 3 --centroids out_funits/ITS_denoised.fasta

source activate pipits_env
cd ~/Documents/FWS/2019_black_spruce_inventory/data/soil_fungi
vsearch --cluster_unoise out_funits/intermediate/derep.ITS2.sizefiltered.fasta --sizein --sizeout --minsize 3 --centroids out_funits/ITS_denoised.fasta
vsearch v2.14.2_linux_x86_64, 7.8GB RAM, 2 cores
https://github.com/torognes/vsearch

Reading file out_funits/intermediate/derep.ITS2.sizefiltered.fasta 100% 
3733528 nt in 21662 seqs, min 102, max 263, avg 172
minsize 3: 304142 sequences discarded.
Masking 100% 
Sorting by abundance 100%
Counting k-mers 100% 
Clustering 100% 
Sorting clusters 100%
Writing clusters 100% 
Clusters: 917 Size min 3, max 65239, avg 23.6
Singletons: 0, 0.0% of seqs, 0.0% of clusters
## That seemed to work.

## Trying to rereplicate
pipits_rereplicate -i out_funits/ITS_denoised.fasta -o out_funits/ITS_denoised_rerep.fasta --uc out_funits/intermediate/derep.uc
Error: Size values in headers added by USEARCH != number of sequences in .uc
65239 3136

## Ok, I see what happened. unoise clustered the sequences, and now the clusters are bigger than in the --uc file. ## How can I deal with this?
```

I am editing the `pipits_process` script, renaming it `pipits_process_ESV`. I am replacing with the OTU clustering section below.

```python
    ##################
    # OTU clustering #
    ##################

    logger(ENDC + "Picking OTUs [VSEARCH]" + ENDC, logging_file, display = True)
    cmd = " ".join([VSEARCH, 
                    "--cluster_fast", tmpDir + "/input_nr.fasta", 
                    "--id", options.VSEARCH_id,
                    "--centroids", tmpDir + "/input_nr_otus.fasta",
                    "--uc", tmpDir + "/input_nr_otus.uc",
                    "--threads", options.threads])
    run_cmd(cmd, logging_file, options.verbose)
```
Replacement:

```python
    ##################
    # Denoising      #
    ##################

    logger(ENDC + "Denoising [VSEARCH]" + ENDC, logging_file, display = True)
    cmd = " ".join([VSEARCH, 
                    "--cluster_unoise", tmpDir + "/input_nr.fasta", 
                    "--minsize 3",
                    "--centroids", tmpDir + "/input_nr_otus.fasta",
                    "--uc", tmpDir + "/input_nr_otus.uc",
                    "--threads", options.threads])
    run_cmd(cmd, logging_file, options.verbose)
```

Trying it out.

```shell
pipits_process_ESV -i out_funits/ITS.fasta -o out_process -v -r

## That worked!!
```


